<template>
  <b-container fluid class="px-2">
    <b-row>
      <b-col md="6" lg="6" sm="12" class="p-0">
        <b-card>
          <template v-slot:header>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <b>{{options.title}}</b>
              </div>
            </div>
          </template>
            <b-form>
              <b-form-group>
                <b-row class="align-items-center">
                  <b-col md="12">
                    <label>Select CSV/XLSX File <span class="text-danger">*</span></label>
                    <b-form-file v-model="file" accept=".csv, .xlsx" ref="file-input"/>
                  </b-col>
                </b-row>
              </b-form-group>
              <slot name="extend"></slot>
            </b-form>
          <template v-slot:footer>
            <b-button size="sm" @click="handleBackToPreviousPage()">
              <i class="icon-arrow-left-circle"></i> Back
            </b-button>
            <b-button class="pull-right" :disabled="showUploadButton" variant="primary" size="sm" @click="uploadFile">
              <i class="icon-cloud-upload"></i> Upload
              <b-spinner variant="white" small class="align-middle ml-1" v-model="isUploading" v-if="isUploading"></b-spinner>
            </b-button>
            <b-button class="mr-2 pull-right" size="sm" @click="downloadExampleFile">
              <i class="icon-cloud-download"></i> Download sample
            </b-button>
          </template>
        </b-card>
      </b-col>
    </b-row>
  </b-container>
</template>

<script>
import { mapActions, mapGetters, mapMutations } from 'vuex'
import * as _ from 'lodash'
import DEFAULT_CONFIG from '@/components/pages/ImportDefaultOptions'
import toastMixin from '@/components/common/toastMixin'

export default {
  name: 'Step1Import',
  mixins: [toastMixin],
  props: {
    inputOptions: {
      type: Object,
      default: () => {
        return {}
      }
    }
  },
  data() {
    return {
      file: null,
      options: _.defaultsDeep(this.$props.inputOptions, DEFAULT_CONFIG.step1),
      showBtnUpload: true,
      isUploading: false
    }
  },
  created() {
    this.setClearListItems()
  },
  computed: {
    ...mapGetters({
      linkSample: `sdk/main/LINK_SAMPLE`,
      currentId: `sdk/main/GET_ID`
    }),
    showUploadButton() {
      return !(this.file && this.showBtnUpload)
    }
  },
  methods: {
    ...mapActions({
      postFile: `sdk/main/POST_FILE`,
      getLinkSample: `sdk/main/LINK_SAMPLE`
    }),
    ...mapMutations({
      setClearListItems: `sdk/main/SET_LIST_ITEMS`,
      setFileSize: `sdk/main/SET_FILE_SIZE`
    }),
    async downloadExampleFile() {
      await this.getLinkSample({module: this.options.module})
      window.location.href = this.linkSample.file_uri
    },
    async uploadFile() {
      try {
        const size = this.$refs['file-input'].$vnode.data.model.value.size
        this.setFileSize(size)
        this.isUploading = true
        let dataUpload = new FormData()
        dataUpload.append('file', this.file)
        let object = this.options.meta
        let keys = Object.keys(object)
        keys.forEach((k, i) => {
          if (object[k] !== '' && object[k] !== undefined && object[k] !== null) {
            dataUpload.append(`${k}`, object[k])
          }
        })
        let params = {
          data: dataUpload,
          module: this.options.module
        }
        this.showBtnUpload = false
        await this.postFile(params)
        this.$router.push({name: this.options.nextStepRouter, params: {import_id: this.currentId}})
      } catch (err) {
        this.vueToast('File uploading failed. Please retry or contact administrator.', 'error')
      }
      this.isUploading = false
      this.showBtnUpload = true
    },
    handleBackToPreviousPage() {
      this.$router.go(-1)
    }
  },
  watch: {
    inputOptions: {
      immediate: true,
      handler: function (newVal, oldVal) {
        if (newVal !== oldVal) {
          this.options = _.defaultsDeep(this.$props.inputOptions, DEFAULT_CONFIG.step1)
        }
      }
    }
  }
}
</script>
<style lang="scss" scoped>
  .container {
    max-width: 100%;
  }
  ::v-deep .footer-custom {
    display: flex;
    align-items: center;
    width: 100%;
  }
</style>
