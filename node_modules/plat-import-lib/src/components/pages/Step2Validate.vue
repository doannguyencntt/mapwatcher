<template>
    <b-container fluid class="px-2">
      <b-row>
        <b-col class="p-0">
          <b-card>
            <template v-slot:header>
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <b>{{options.title}}</b>
                </div>
              </div>
            </template>
            <import-progress-bar v-if="options.progressBar" :options="options"></import-progress-bar>
            <b-table-simple bordered small v-if="rawFields && rawFields.length > 0" class="overflow-auto height" responsive="sm" thead-class="sticky-top" show-empty>
              <b-thead :head-variant="'light'" class="sticky-top">
                <b-tr>
                  <b-th class="text-nowrap" v-for="(item, key) in rawFields" :key="key">{{item.label}}</b-th>
                </b-tr>
              </b-thead>
              <b-tbody>
                <b-tr>
                  <b-th v-for="(item, key) in mappedCol" :key="key">
                    <b-form-select :title="getNameColumn(item.upload_col)" v-model="item.upload_col" :options="optionsField" value-field="name" text-field="label" aria-invalid="true" class="text-truncate text-nowrap width-custom-select"/>
                  </b-th>
                </b-tr>
                <b-tr v-for="(item, index) in listItems.items" :key="index">
                  <b-td v-for="(col, key) in mappedCol" :key="key" :title="item[col.upload_col] || ''" class="text-truncate text-truncate max-width-300">
                    <span v-if="item[col.upload_col]">{{ item[col.upload_col] }}</span>
                    <span v-else class="pill-null">null</span>
                  </b-td>
                </b-tr>
              </b-tbody>
              <template slot="empty">
                <div class="d-flex justify-content-center align-item-center text-secondary p-5">No data</div>
              </template>
            </b-table-simple>
            <nav class="d-flex justify-content-center">
              <b-pagination v-model="page" @click.native="getListItems({id: currentId, page: page, limit: limit, type: type, key: key, module: options.module})" v-if="listItems.page_count && listItems.page_count > 1" :total-rows="listItems.total || 0" :per-page="limit" prev-text="Prev" next-text="Next" hide-goto-end-buttons />
            </nav>
            <template v-slot:footer>
              <b-button size="sm" @click="handleBackToPreviousPage()">
                <i class="icon-arrow-left-circle"></i> Back
              </b-button>
              <b-button :disabled="!getStatusUpload || isValidating" variant="primary" size="sm" class="pull-right" @click="validate">
                <i class="icon-check"></i>
                Validate
                <b-spinner variant="white" small class="align-middle ml-1" v-model="isValidating" v-if="isValidating"></b-spinner>
              </b-button>
            </template>
          </b-card>
        </b-col>
      </b-row>
    </b-container>
</template>

<script>
import { mapGetters, mapActions, mapMutations } from 'vuex'
import * as _ from 'lodash'
import DEFAULT_CONFIG from '@/components/pages/ImportDefaultOptions'
import progressBar from '@/components/progressBar'
import toastMixin from '@/components/common/toastMixin'

export default {
  name: 'Step2Validate',
  mixins: [toastMixin],
  components: {
    'import-progress-bar': progressBar
  },
  props: {
    inputOptions: {
      type: Object,
      default: () => {
        return {}
      }
    }
  },
  data() {
    return {
      a: 0,
      fields: [],
      config: [],
      limit: 10,
      page: 1,
      items: {},
      options: _.defaultsDeep(this.$props.inputOptions, DEFAULT_CONFIG.step2),
      isValidating: false,
      currentId: null
    }
  },
  computed: {
    ...mapGetters({
      rawFields: `sdk/main/GET_LIST_RAW_FIELDS`,
      optionsField: `sdk/main/GET_LIST_OPTIONS`,
      mappedCol: `sdk/main/GET_LIST_MAPPED_COL`,
      importId: `sdk/main/GET_ID`,
      listItems: `sdk/main/GET_LIST_ITEMS`,
      progress: `sdk/main/PROGRESS`,
      status: `sdk/main/STATUS`,
      fileSize: `sdk/main/FILE_SIZE`
    }),
    watchCurrentId () {
      return this.currentId
    },
    watchListItems () {
      return this.listItems
    },
    getStatusUpload() {
      if (this.options.progressBar) {
        return this.status === 'uploaded'
      }
      return true
    }
  },
  methods: {
    ...mapActions({
      getListItems: `sdk/main/GET_LIST_ITEMS`,
      validateColumns: `sdk/main/VALIDATE`,
      getInfoImport: `sdk/main/INFO_IMPORT`
    }),
    ...mapMutations({
      setStatus: `sdk/main/SET_STATUS`,
      setClearListItems: `sdk/main/SET_LIST_ITEMS`
    }),
    async validate() {
      try {
        this.isValidating = true
        this.config = this.mappedCol.map((item) => {
          return {
            upload_col: item.upload_col,
            target_col: item.target_col
          }
        })
        let params = {
          column_mapping: this.config,
          id: this.currentId,
          module: this.options.module
        }
        await this.validateColumns(params)
        this.$router.push({name: this.options.nextStepRouter, params: {import_id: this.currentId}})
      } catch (err) {
        this.vueToast('Validation failed. Please retry or contact administrator.', 'error')
        this.setClearListItems() // remove list items if validate failed
      }
      this.isValidating = false
    },
    getNameColumn(value) {
      if (this.optionsField && this.optionsField[0].name && this.optionsField[0].label && this.optionsField[0].name !== null && this.optionsField[0].label !== 'None Selected') {
        this.optionsField.splice(0, 0, {name: '', label: 'None Selected'})
      }
      const { label } = (this.optionsField || []).find(ops => ops.name === value && value !== 'None') || {}
      return label
    },
    handleBackToPreviousPage() {
      this.$router.go(-1)
      this.setClearListItems()
    }
  },
  created () {
    this.currentId = this.$route.params.import_id ? this.$route.params.import_id : this.importId
    if (!this.options.progressBar) {
      this.getListItems({id: this.currentId, page: 1, limit: 10, module: this.options.module})
    }
  },
  watch: {
    status: {
      handler: function (newVal, oldVal) {
        if (newVal === 'uploaded') {
          this.getListItems({id: this.currentId, page: 1, limit: 10, module: this.options.module})
        }
      }
    },
    watchListItems (newList, oldList) {
      this.items = newList && newList.items && newList.items.map((item) => { delete item._meta })
    },
    inputOptions: {
      immediate: true,
      handler: function (newVal, oldVal) {
        if (newVal !== oldVal) {
          this.options = _.defaultsDeep(this.$props.inputOptions, DEFAULT_CONFIG.step2)
        }
      }
    }
  },
  mounted() {
    if (this.status === 'validated' && this.options.progressBar) {
      this.setStatus('uploaded')
    }
  }
}
</script>
<style lang="scss" scoped>
  .container {
    max-width: 100%;
  }
  /deep/ .table .thead-light th {
    position: sticky;
    top: -1px;
    z-index: 999;
    border-bottom: unset;
  }
  .height{
    max-height: 60vh;
  }
  .table-import-progress{
    overflow-x: auto
  }
  .max-width-300 {
    max-width: 300px;
  }
  .pill-null {
    line-height: normal;
    border-radius: 3px;
    padding: 0 .5rem;
    display: inline-block;
    font-size: 90%;
    background-color: grey;
    color: #fff;
  }
  .width-custom-select {
    min-width: 90px;
  }
</style>
