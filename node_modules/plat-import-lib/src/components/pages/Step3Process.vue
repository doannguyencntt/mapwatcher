<template>
<b-container fluid class="px-2">
    <b-row>
      <b-col class="p-0">
        <b-card>
          <template v-slot:header>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <b>{{options.title}}</b>
              </div>
            </div>
          </template>
          <div class="text-center mb-4 alert alert-info" v-if="infoValidated.summary">
            Total <span class="badge badge-primary mr-5">{{infoValidated.summary.total}}</span> Valid <span class="badge badge-success mr-5">{{infoValidated.summary.valid}}</span> Invalid <span class="badge badge-danger mr-5">{{validateError}}</span>
          </div>
          <b-row class="d-flex justify-content-center align-items-center">
            <b-col md="3" class="pl-5 mt-0 mb-4 pr-0">
              <b-form-select v-model="type" :options="listAction" text-field="name" class="select--custom" @change="searchChange()"></b-form-select>
            </b-col>
            <b-col md="4" class="mt-0 mb-4">
              <b-form-group class="mb-0">
                <b-input-group class="search cancel-action">
                  <b-form-input v-model="key" @keypress.enter="searchChange()" placeholder="Search for data">
                  </b-form-input>
                  <i v-if="key" @click="key='', searchChange()" class="icon-close cancel-icon"></i>
                  <b-input-group-append>
                    <b-button @click="searchChange()">
                      <i class="icons icon-magnifier"></i>
                    </b-button>
                  </b-input-group-append>
                </b-input-group>
              </b-form-group>
            </b-col>
            <b-spinner variant="dark" small class="align-middle ml-3" v-model="isLoading" v-if="isLoading"/>

          </b-row>
          <import-progress-bar v-if="options.progressBar" :options="options"></import-progress-bar>
          <b-table :fields="fields" :items="listItems.items" bordered small :head-variant="'light'" v-if="infoValidated.columns" class="overflow-auto height" thead-class="sticky-top text-nowrap" tbody-class="text-nowrap" responsive="sm" show-empty>
            <template v-slot:cell()="row">
              <span v-if="row.value" :title="row.value">{{ row.value }}</span>
              <span v-else class="pill-null">null</span>
            </template>
            <template v-slot:cell(_meta)="row" v-if="listItems.items && listItems.items[0] && listItems.items[0]._meta">
              <ul class="mb-0 w-100 p-0" v-for="(item, index) in row.item._meta.validation_errors" :key="index" style="list-style-position: inside;">
                <li class="text-danger text-truncate max-width-300" :title="item.message.join(', ')">
                  {{item.message.join(', ')}}
                </li>
              </ul>
              <div class="text-left d-flex justify-content-center align-items-center">
                <span v-if="!row.item._meta.validation_errors.length > 0" class="badge badge-success"><i class="fa fa-check-circle"></i> OK</span>
              </div>
            </template>
            <template slot="empty">
              <div class="d-flex justify-content-center align-item-center text-secondary p-5">No data</div>
            </template>
            <template v-slot:cell(row)="row" v-if="listItems.items && listItems.items[0] && listItems.items[0]._meta">
              <div class="text-center">{{row.item._meta.number}}</div>
            </template>
            <template v-slot:cell(title)="row" v-if="listItems.items && listItems.items[0] && listItems.items[0].title">
              <div :title="row.item.title" class="text-truncate max-width-300" >{{row.item.title}}</div>
            </template>
          </b-table>
          <nav class="d-flex justify-content-center">
            <b-pagination v-model="page" @click.native="getListItems({id: currentId, page: page, limit: limit, type: type, key: key, module: options.module})" v-if="listItems.page_count && listItems.page_count > 1" :total-rows="listItems.total || 0" :per-page="limit" prev-text="Prev" next-text="Next" hide-goto-end-buttons />
          </nav>
          <template v-slot:footer>
            <b-button size="sm" @click="handleBackToPreviousPage()">
              <i class="icon-arrow-left-circle"></i> Back
            </b-button>
            <b-button :disabled="!getStatusValidate || isProcessing" variant="primary" size="sm" class="pull-right" @click="finish">
              <i class="icon-check"></i> Process
              <b-spinner variant="white" small class="align-middle ml-1" v-model="isProcessing" v-if="isProcessing"></b-spinner>
            </b-button>
            <b-button size="sm" :disabled="isDownloading || progress !== 100" class="pull-right mr-2" @click="downloadAll">
              <i class="icon-cloud-download"></i> Download All
              <b-spinner variant="white" small class="align-middle ml-1" v-model="isDownloading" v-if="isDownloading"></b-spinner>
            </b-button>
          </template>
        </b-card>
      </b-col>
    </b-row>
  </b-container>
</template>

<script>
import { mapGetters, mapActions } from 'vuex'
import * as _ from 'lodash'
import DEFAULT_CONFIG from '@/components/pages/ImportDefaultOptions'
import progressBar from '@/components/progressBar'
import toastMixin from '@/components/common/toastMixin'

export default {
  name: 'Step3Process',
  components: {
    'import-progress-bar': progressBar
  },
  mixins: [toastMixin],
  props: {
    inputOptions: {
      type: Object,
      default: () => {
        return {}
      }
    }
  },
  data() {
    return {
      fields: [],
      type: null,
      key: '',
      listAction: [
        { value: null, name: 'All' },
        { value: 'valid', name: 'Valid' },
        { value: 'invalid', name: 'Invalid' }
      ],
      page: 1,
      limit: 10,
      options: _.defaultsDeep(this.$props.inputOptions, DEFAULT_CONFIG.step3),
      isDownloading: false,
      isProcessing: false,
      isLoading: false,
      currentId: null
    }
  },
  computed: {
    ...mapGetters({
      infoValidated: `sdk/main/GET_LIST_VALIDATED`,
      importId: `sdk/main/GET_ID`,
      listItems: `sdk/main/GET_LIST_ITEMS`,
      linkAll: `sdk/main/LINK_ALL`,
      progress: `sdk/main/PROGRESS`,
      status: `sdk/main/STATUS`,
      listField: `sdk/main/GET_LIST_RAW_FIELDS`
    }),
    getStatusValidate() {
      if (this.options.progressBar) {
        return this.status === 'validated'
      }
      return true
    },
    validateError() {
      if (this.status !== 'validated' && this.options.progressBar) {
        return 0
      }
      return this.infoValidated.summary.total - this.infoValidated.summary.valid
    }
  },
  methods: {
    ...mapActions({
      getListItems: `sdk/main/GET_LIST_ITEMS`,
      getLinkAll: `sdk/main/LINK_ALL`,
      confirm: `sdk/main/CONFIRM`,
      getLinkInvalid: `sdk/main/LINK_INVALID`
    }),
    async searchChange() {
      try {
        this.isLoading = true
        await this.getListItems({id: this.currentId, page: 1, limit: 10, type: this.type, key: this.key, module: this.options.module})
      } catch (err) {
        console.log('err', err)
      }
      this.isLoading = false
    },
    mapFields() {
      if (this.infoValidated && this.infoValidated.columns) {
        this.fields = this.infoValidated.columns
        this.fields.splice(0, 0, {name: '_meta', label: 'Result'})
        this.fields.splice(0, 0, {name: 'row', label: 'Row'})
        this.fields = this.fields.map((item) => {
          return {
            key: item.name,
            label: item.label
          }
        })
      }
    },
    async finish() {
      try {
        this.isProcessing = true
        await this.confirm({id: this.currentId, module: this.options.module})
        this.$router.push({name: this.options.nextStepRouter, params: {import_id: this.currentId}})
      } catch (err) {
        this.vueToast('Fail to process. Please retry or contact administrator.', 'error')
      }
      this.isProcessing = false
    },
    async downloadAll() {
      this.isDownloading = true
      await this.getLinkAll({id: this.currentId, module: this.options.module})
      this.isDownloading = false
      window.location.href = this.linkAll.file_uri
    },
    handleBackToPreviousPage() {
      this.$router.go(-1)
    }
  },
  async created() {
    this.fields = this.listField.map((item) => {
      return {
        key: item.name,
        label: item.label
      }
    })
    this.currentId = this.$route.params.import_id ? this.$route.params.import_id : this.importId
    if (!this.options.progressBar) {
      await this.getListItems({id: this.currentId, page: 1, limit: 10, module: this.options.module})
    }
  },
  watch: {
    inputOptions: {
      immediate: true,
      handler: function (newVal, oldVal) {
        if (newVal !== oldVal) {
          this.options = _.defaultsDeep(this.$props.inputOptions, DEFAULT_CONFIG.step3)
        }
      }
    },
    status: {
      handler: async function (newVal, oldVal) {
        if (newVal === 'validated') {
          await this.getListItems({id: this.currentId, page: 1, limit: 10, module: this.options.module})
          this.mapFields()
        }
      }
    }
  }
}
</script>

<style lang="scss" scoped>
  .container {
    max-width: 100%;
  }
  .cancel-icon {
    position: absolute;
    cursor: pointer;
    right: 50px;
    top: 50%;
    z-index: 20;
    transform: translateY(-50%);
  }
  ::v-deep .table .thead-light th {
  position: sticky;
  top: -1px;
  z-index: 999;
  border-bottom: unset;
  }
  .height{
    max-height: 60vh;
  }
 .max-width-300 {
    max-width: 300px;
  }
  .pill-null {
    line-height: normal;
    border-radius: 3px;
    padding: 0 .5rem;
    display: inline-block;
    font-size: 90%;
    background-color: grey;
    color: #fff;
  }
</style>
