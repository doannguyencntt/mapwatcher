<template>
  <b-container fluid class="px-2">
    <b-row>
      <b-col class="p-0">
        <b-card>
          <template v-slot:header>
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <b>{{options.title}}</b>
              </div>
            </div>
          </template>
          <div class="text-center mb-4 alert alert-info" v-if="infoResults.summary">
            Total <span class="badge badge-primary mr-5">{{infoResults.summary.total}}</span>
            Valid <span class="badge badge-success mr-5">{{infoResults.summary.valid}}</span>
            Invalid <span class="badge badge-danger mr-5">{{invalidRow}}</span>
            Processed <span class="badge badge-success mr-5">{{infoResults.summary.completed}}</span>
            Error <span class="badge badge-danger mr-5">{{processError}}</span>
            Created <span class="badge badge-warning mr-5">{{processCreated}}</span>
            Updated <span class="badge badge-info mr-5">{{processUpdated}}</span>
          </div>
          <b-row class="justify-content-center mb-4 max-width-200px">
            <b-col md="3" class=" d-flex align-items-center mt-0 pr-0">
              <b-form-select v-model="type" :options="listAction" text-field="name" class="select--custom" @change="searchChange()"></b-form-select>
              <b-spinner variant="white" small class="align-middle ml-3" v-model="isLoading" v-if="isLoading"></b-spinner>
            </b-col>
          </b-row>
          <import-progress-bar v-if="options.progressBar" :options="options"></import-progress-bar>
          <b-table :fields="fields" :items="listItems.items" bordered small :head-variant="'light'" v-if="infoResults.columns" class="overflow-auto height" responsive="sm" thead-class="sticky-top text-truncate text-nowrap" tbody-class="text-nowrap" show-empty>
            <template v-slot:cell()="row">
              <span v-if="row.value" :title="row.value">{{ row.value }}</span>
              <span v-else class="pill-null">null</span>
            </template>
            <template v-slot:cell(_meta)="row">
              <div v-if="listItems.items[0] && listItems.items[0]._meta && listItems.items[0]._meta.processing_errors &&listItems.items[0]._meta.processing_errors.length > 0">
                <ul class="mb-0 p-0" v-for="(item, index) in row.item._meta.processing_errors" :key="index">
                  <li class="text-danger text-truncate max-width-300" :title="capitalizeFirstLetter(inItem)" v-for="(inItem, index1) in item.message" :key="index1">
                    {{capitalizeFirstLetter(inItem)}}
                  </li>
                </ul>
              </div>
              <div v-if="listItems.items[0] && listItems.items[0]._meta.validation_errors.length > 0">
                <ul class="mb-0 p-0" v-for="(item, index) in row.item._meta.validation_errors" :key="index">
                  <li class="text-danger text-truncate max-width-300" :title="capitalizeFirstLetter(inItem)" v-for="(inItem, index1) in item.message" :key="index1">
                    {{capitalizeFirstLetter(inItem)}}
                  </li>
                </ul>
              </div>
              <div class="text-left" v-if="listItems.items[0] && listItems.items[0]._meta.validation_errors.length === 0 && listItems.items[0]._meta.processing_errors.length === 0">
                <span v-if="!row.item._meta.validation_errors.length > 0" class="badge badge-success"><i class="fa fa-check-circle"></i> OK</span>
              </div>
            </template>
            <template v-slot:cell(row)="row" v-if="listItems.items[0] && listItems.items[0]._meta">
              <div class="text-center">{{row.item._meta.number}}</div>
            </template>
            <template v-slot:cell(title)="row" v-if="listItems.items[0] && listItems.items[0].title">
              <div class="text-truncate max-width-300" :title="row.item.title">{{row.item.title}}</div>
            </template>
            <template slot="empty">
              <div class="d-flex justify-content-center align-item-center text-secondary p-5">No data</div>
            </template>
          </b-table>
          <nav class="d-flex justify-content-center">
            <b-pagination v-model="page" @click.native="getListItems({id: currentId, page: page, limit: limit, type: type, module: options.module})" v-if="listItems.page_count && listItems.page_count > 1" :total-rows="listItems.total || 0" :per-page="limit" prev-text="Prev" next-text="Next" hide-goto-end-buttons />
          </nav>
          <template v-slot:footer>
            <b-button :disabled="!getStatusProcess || isDownloading" variant="primary" size="sm" class="pull-right" @click="complete">
              <i class="icon-check"></i> Complete
            </b-button>
            <b-button :disabled="isDownloadingError || errorRow == 0" size="sm" class="pull-right mr-2" @click="downloadError">
              <i class="icon-cloud-download"></i> Download Error
              <b-spinner variant="dark" small class="ml-1" v-model="isDownloadingError" v-if="isDownloadingError"></b-spinner>
            </b-button>
            <b-button size="sm" :disabled="isDownloading || invalidRow === 0 " class="pull-right mr-2" @click="downloadInvalid" v-if="options.downloadInvalidEnabled">
              <i class="icon-cloud-download"></i> Download Invalid
              <b-spinner variant="white" small class="align-middle ml-1" v-model="isDownloading" v-if="isDownloading"></b-spinner>
            </b-button>
          </template>
        </b-card>
      </b-col>
    </b-row>
  </b-container>
</template>

<script>
import { mapGetters, mapActions, mapMutations } from 'vuex'
import * as _ from 'lodash'
import DEFAULT_CONFIG from '@/components/pages/ImportDefaultOptions'
import progressBar from '@/components/progressBar'
import toastMixin from '@/components/common/toastMixin'

export default {
  name: 'Step4Result',
  components: {
    'import-progress-bar': progressBar
  },
  mixins: [toastMixin],
  props: {
    inputOptions: {
      type: Object,
      default: () => {
        return {}
      }
    }
  },
  data() {
    return {
      fields: [],
      page: 1,
      limit: 10,
      type: 'processed',
      options: _.defaultsDeep(this.$props.inputOptions, DEFAULT_CONFIG.step4),
      listAction: [
        { value: 'processed', name: 'Processed' },
        { value: 'valid', name: 'Valid' },
        { value: 'error', name: 'Error' },
        { value: 'invalid', name: 'Invalid' },
        { value: 'created', name: 'Created' },
        { value: 'updated', name: 'Updated' }
      ],
      invalidRow: null,
      errorRow: null,
      createdRow: null,
      updatedRow: null,
      isDownloading: false,
      isLoading: false,
      isDownloadingError: false,
      currentId: null
    }
  },
  computed: {
    ...mapGetters({
      infoResults: `sdk/main/GET_RESULTS`,
      importId: `sdk/main/GET_ID`,
      listItems: `sdk/main/GET_LIST_ITEMS`,
      linkInvalid: `sdk/main/LINK_INVALID`,
      linkError: `sdk/main/LINK_ERROR`,
      progress: `sdk/main/PROGRESS`,
      status: `sdk/main/STATUS`,
      listField: `sdk/main/GET_LIST_RAW_FIELDS`
    }),
    getStatusProcess() {
      this.calHeaderInfo()
      if (this.options.progressBar) {
        if (this.status === 'processed') {
          this.getListItems({id: this.currentId, page: 1, limit: 10, type: this.type, module: this.options.module})
          return this.status === 'processed'
        }
        if (this.status === 'error') {
          this.getListItems({id: this.currentId, page: 1, limit: 10, type: this.type, module: this.options.module})
          return this.status === 'error'
        }
      }
      return false
    },
    processError() {
      if (this.status !== 'processed' && this.options.progressBar) {
        return 0
      }
      return this.errorRow
    },
    processCreated() {
      if (this.status !== 'processed' && this.options.progressBar) {
        return 0
      }
      return this.infoResults && this.infoResults.summary && this.infoResults.summary.created && this.infoResults.summary.completed ? this.infoResults.summary.created : 0
    },
    processUpdated() {
      if (this.status !== 'processed' && this.options.progressBar) {
        return 0
      }
      return this.infoResults && this.infoResults.summary && this.infoResults.summary.create && this.infoResults.summary.completed ? this.infoResults.summary.completed - this.infoResults.summary.created : 0
    }
  },
  methods: {
    ...mapActions({
      getListItems: `sdk/main/GET_LIST_ITEMS`,
      getLinkInvalid: `sdk/main/LINK_INVALID`,
      getLinkError: `sdk/main/LINK_ERROR`
    }),
    ...mapMutations({
      setClearListItems: `sdk/main/SET_LIST_ITEMS`
    }),
    async searchChange() {
      this.isLoading = true
      await this.getListItems({id: this.currentId, page: 1, limit: 10, type: this.type, module: this.options.module})
      this.isLoading = false
    },
    capitalizeFirstLetter(string) {
      return string.charAt(0).toUpperCase() + string.slice(1)
    },
    mapFields() {
      this.fields = this.infoResults.columns || []
      this.fields.splice(0, 0, {name: '_meta', label: 'Result'})
      this.fields.splice(0, 0, {name: 'row', label: 'Row'})
      this.fields = this.fields.map((item) => {
        return {
          key: item.name,
          label: item.label
        }
      })
    },
    complete() {
      this.$router.push({name: this.options.nextStepRouter})
      this.setClearListItems() // clear list items
    },
    async downloadInvalid() {
      this.isDownloading = true
      await this.getLinkInvalid({id: this.currentId, module: this.options.module})
      this.isDownloading = false
      if (_.isNull(this.linkInvalid.file_uri)) {
        this.vueToast('No data invalid', 'error')
      } else {
        window.location.href = this.linkInvalid.file_uri
      }
    },
    async downloadError() {
      this.isDownloadingError = true
      await this.getLinkError({id: this.currentId, module: this.options.module})
      this.isDownloadingError = false
      if (_.isNull(this.linkInvalid.file_uri)) {
        this.vueToast('No data error', 'error')
      } else {
        window.location.href = this.linkInvalid.file_uri
      }
    },
    calHeaderInfo() {
      this.invalidRow = this.infoResults.summary ? this.infoResults.summary.total - this.infoResults.summary.valid : 0
      this.errorRow = this.infoResults.summary ? this.infoResults.summary.total - this.invalidRow - this.infoResults.summary.completed : 0
      this.createdRow = this.infoResults && this.infoResults.summary && this.infoResults.summary.created ? this.infoResults.summary.created : 0
      this.updatedRow = this.infoResults && this.infoResults.summary && this.infoResults.summary.create && this.infoResults.summary.completed ? this.infoResults.summary.completed - this.infoResults.summary.created : 0
    }
  },
  async created() {
    this.fields = this.listField.map((item) => {
      return {
        key: item.name,
        label: item.label
      }
    })
    this.currentId = this.$route.params.import_id ? this.$route.params.import_id : this.importId
    this.calHeaderInfo()
  },
  watch: {
    inputOptions: {
      immediate: true,
      handler: function (newVal, oldVal) {
        if (newVal !== oldVal) {
          this.options = _.defaultsDeep(this.$props.inputOptions, DEFAULT_CONFIG.step4)
        }
      }
    },
    status: {
      handler: async function (newVal, oldVal) {
        if (newVal === 'processed') {
          await this.getListItems({id: this.currentId, page: 1, limit: 10, module: this.options.module, type: this.type})
          this.mapFields()
        }
      }
    }
  }
}
</script>
<style lang="scss" scoped>
  .container {
    max-width: 100%;
  }
  /deep/ .table .thead-light th {
    position: sticky;
    top: -1px;
    z-index: 999;
    border-bottom: unset;
  }
  .height{
    max-height: 60vh;
  }

  .select--custom {
    max-width: 200px;
    min-width: 180px;
    width: 100%;
  }

  .max-width-300 {
    max-width:300px;
  }

  .pill-null {
    line-height: normal;
    border-radius: 3px;
    padding: 0 .5rem;
    display: inline-block;
    font-size: 90%;
    background-color: grey;
    color: #fff;
  }
</style>
