<template>
  <div class="d-flex justify-content-center align-items-center mb-3">
    <span class="mr-2 text-capitalize">{{ status }}</span>
    <b-progress :max="100" class="w-25" show-progress :animated="showSpinner">
      <b-progress-bar class="text-dark" :value="progress">{{ getProgress }}%</b-progress-bar>
    </b-progress>
    <div v-if="options.estimateTimeBar">
      <span v-if="progress > 0 && progress < 100" class="ml-3">Completed&nbsp;{{ timeEstimate | duration('humanize', true) }}</span>
      <span v-else-if="progress === 0 && this.currentId" class="ml-3">Estimating completed time</span>
    </div>
    <i v-if="showSpinner && !options.estimateTimeBar" class="fa fa-spinner fa-fw ml-3 fa-lg" :class="{ 'fa-spin': showSpinner }"></i>
  </div>
</template>
<script>
import { mapGetters, mapActions } from 'vuex'

export default {
  name: 'progressBar',
  props: {
    options: {
      type: Object,
      default: () => {
        return {}
      }
    }
  },
  data() {
    return {
      intervalProgess: null,
      intervalTime: null,
      currentId: null,
      timeEstimate: null
    }
  },
  computed: {
    ...mapGetters({
      progress: `sdk/main/PROGRESS`,
      status: `sdk/main/STATUS`,
      importId: `sdk/main/GET_ID`,
      fileSize: `sdk/main/FILE_SIZE`,
      created_at: `sdk/main/GET_CREATED_AT`,
      validation_started: `sdk/main/GET_VALIDATION_STARTED`,
      process_started: `sdk/main/GET_PROCESS_STARTED`
    }),
    getProgress() {
      return this.progress
    },
    showSpinner() {
      if (this.progress === 100) {
        this.stopInterval()
      }
      return this.progress < 100
    },
    timeStarted() {
      if (this.status === 'uploading') return this.created_at
      else if (this.status === 'validating') return this.validation_started
      else if (this.status === 'processing') return this.process_started
      return null
    }
  },
  methods: {
    ...mapActions({
      getInfoImport: `sdk/main/INFO_IMPORT`
    }),
    stopInterval() {
      this.timeEstimate = 0
      clearInterval(this.intervalProgess)
      clearInterval(this.intervalTime)
    },
    handlerGetInfoImport() {
      let payload = {
        id: this.currentId,
        module: this.options.module
      }
      this.getInfoImport(payload)
    }
  },
  created() {
    this.currentId = this.$route.params.import_id ? this.$route.params.import_id : this.importId
  },

  mounted() {
    const _self = this
    this.intervalProgess = setInterval(function() {
      if (_self.progress < 100) {
        _self.handlerGetInfoImport()
      }
    }, 5000)
    this.intervalTime = setInterval(() => {
      if (this.progress > 0 && this.options.estimateTimeBar) {
        let uploadedBytes = Number((this.progress * this.fileSize) / 100)
        let timeElapsed = Date.now() - new Date(this.timeStarted)

        let uploadSpeed = uploadedBytes / timeElapsed
        this.timeEstimate = (this.fileSize - uploadedBytes) / uploadSpeed // per minute
        return this.timeEstimate
      }
    }, 2500)
  },
  destroyed() {
    clearInterval(this.intervalProgess)
    clearInterval(this.intervalTime)
  }
}
</script>
